# Created 2022-11-11 Fr 17:59
#+title: Ansible Pot
#+author: Daniel Ziltener
I am a role to manage your Pot jails on FreeBSD. My source is located in the [[blob/master/pot.org][pot.org]] file.

* Requirements

None.

* Role Variables

** Pot Server

#+name: server-default-vars
| Variable            | Default         | Info                     |
|---------------------+-----------------+--------------------------|
| enabled             | false           |                          |
| vnet_enabled        | false           | Triggers ~pot vnet-init~ |
| fscomps             | []              | A list of fscomps        |
| bridges             | []              | A list of bridges        |
| bases               | []              | A list of bases          |
| jails               | []              | A list of jails          |
| zfs_root            | tank/pot        | pot.conf value           |
| fs_root             | /opt/pot        | pot.conf value           |
| cache               | /var/cache/pot  | pot.conf value           |
| tmp                 | /tmp            | pot.conf value           |
| mktemp_suffix       | .XXXXXXXX       | pot.conf value           |
| hostname_max_length | 64              | pot.conf value           |
| network             | "10.192.0.0/10" | pot.conf value           |
| netmask             | "255.192.0.0"   | pot.conf value           |
| gateway             | "10.192.0.1"    | pot.conf value           |
| extif               | em0             | pot.conf value           |

#+begin_src yaml
  ---
  pot:
    enabled: false
    vnet_enabled: false
    fscomps: []
    bridges: []
    bases: []
    jails: []
    zfs_root: tank/pot
    fs_root: /opt/pot
    cache: /var/cache/pot
    tmp: /tmp
    mktemp_suffix: .XXXXXXXX
    hostname_max_length: 64
    network: 10.192.0.0/10
    netmask: 255.192.0.0
    gateway: 10.192.0.1
    extif: em0
#+end_src

** Bridges

The ones created with ~pot create-private-bridge~.

#+name: bridge-vars
| Variable | Default   | Info                                 |
|----------+-----------+--------------------------------------|
| name     |           |                                      |
| size     |           |                                      |
| state    | "present" | can be ~present~ or ~absent~         |
| ignore   | false     | Tells the role to ignore this bridge |

#+begin_src yaml
  ---
  bridge:
    name: '{{ selectedbridge.name|default("") }}'
    size: '{{ selectedbridge.size|default("") }}'
    state: '{{ selectedbridge.state|default("present") }}'
    ignore: '{{ selectedbridge.ignore|default("false") }}'
#+end_src

** FS Components

The ones created with ~pot create-fscomp~.

#+name: fscomp-vars
| Variable | Default   | Info                                       |
|----------+-----------+--------------------------------------------|
| name     |           |                                            |
| state    | "present" | can be ~present~ or ~absent~               |
| ignore   | false     | Tells the role to ignore this fs component |

#+begin_src yaml
  ---
  fscomp:
    name: '{{ selectedfscomp.name|default("") }}'
    state: '{{ selectedfscomp.state|default("present") }}'
    ignore: '{{ selectedfscomp.ignore|default("false") }}'
#+end_src

** Bases

The ones created with ~pot create-base~.

#+name: base-vars
| Variable | Default   | Info                               |
|----------+-----------+------------------------------------|
| name     |           | default: the release               |
| release  |           |                                    |
| state    | "present" | can be ~present~ or ~absent~.      |
| ignore   | false     | Tells the role to ignore this base |

#+begin_src yaml
  ---
  base:
    name: '{{ selectedbase.name|default("") }}'
    release: '{{ selectedbase.release|default("") }}'
    state: '{{ selectedbase.state|default("present") }}'
    ignore: '{{ selectedbase.ignore|default("false") }}'
#+end_src

** Jails

For each jail, you can supply a number of arguments. Please note that while renaming pots is implemented, it will break this role, due to  Pot not renaming the actual on-disk jail directory.

#+name: jail-vars
| Variable      | Default   | Info                                                                    |
|---------------+-----------+-------------------------------------------------------------------------|
| name          |           |                                                                         |
| new_name      |           | Renames the jail. Needs state to be anything but ~absent~ or ~started~. |
| ignore        | false     | Tells the role to ignore this jail                                      |
| state         | "present" | can be ~present~, ~absent~, ~started~, ~stopped~, ~restarted~           |
| ip            | "auto"    |                                                                         |
| dns           | "inherit" |                                                                         |
| network_stack | "dual"    |                                                                         |
| network_type  | "inherit" |                                                                         |
| bridge_name   |           |                                                                         |
| base          | "13.1"    |                                                                         |
| pot           |           | The pot to be used as reference                                         |
| type          | "multi"   |                                                                         |
| level         |           |                                                                         |
| flavour       |           |                                                                         |

#+begin_src yaml
  ---
  jail:
    name: '{{ selectedjail.name|default("") }}'
    new_name: '{{ selectedjail.new_name|default("") }}'
    ignore: '{{ selectedjail.ignore|default("false") }}'
    state: '{{ selectedjail.state|default("present") }}'
    ip: '{{ selectedjail.ip|default("auto") }}'
    dns: '{{ selectedjail.dns|default("inherit") }}'
    network_stack: '{{ selectedjail.network_stack|default("dual") }}'
    network_type: '{{ selectedjail.network_type|default("inherit") }}'
    bridge_name: '{{ selectedjail.bridge_name|default("") }}'
    base: '{{ selectedjail.base|default("13.1") }}'
    pot: '{{ selectedjail.pot|default("") }}'
    type: '{{ selectedjail.type|default("multi") }}'
    level: '{{ selectedjail.level|default("") }}'
    flavour: '{{ selectedjail.flavour|default("") }}'
#+end_src

** Collected Variables

#+name: pot-intel
| Variable         | Default | Info                                                                        |
|------------------+---------+-----------------------------------------------------------------------------|
| initialized      |         | If ~pot init~ has been run already.                                         |
| vnet_initialized |         | If ~pot vnet-start~ has been run already.                                   |
| version          |         | The pot version.                                                            |
| fscomps          | []      |                                                                             |
| bridges          | []      |                                                                             |
| bases            | []      |                                                                             |
| jails            | {}      | A JSON list of the data returned by ~pot info -p~; keys are the jail names. |

#+begin_src yaml
  ---
  potintel:
    initialized: '{{ ansible_local.pot.initialized|default("") }}'
    vnet_initialized: '{{ ansible_local.pot.vnet_initialized|default("") }}'
    version: '{{ ansible_local.pot.version|default("") }}'
    fscomps: '{{ ansible_local.pot.fscomps|default("[]") }}'
    bridges: '{{ ansible_local.pot.bridges|default("[]") }}'
    bases: '{{ ansible_local.pot.bases|default("[]") }}'
    jails: '{{ ansible_local.pot.jails|default("{}") }}'
#+end_src

* Dependencies

Needs the =community.general= collection.

* Example Playbook

#+begin_src yaml
  - hosts: all
    become: yes
    remote_user: root
    roles:
    - role: /vagrant
      vars:
        pot:
  	enabled: true
  	vnet_enabled: true
  	zfs_root: tank/pot
  	extif: vtnet0
  	bases:
  	- release: 13.1
  	pots:
  	- name: testpot1
  	  state: absent
  	- name: ignorepot
  	  state: present
  	  ignore: true
  	- name: testpot1
  	  state: restarted
#+end_src

* License

GPL3.0

* Author Information
